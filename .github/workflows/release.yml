name: Release

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: ''

jobs:
  # Extract version from Cargo.toml
  extract-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version from Cargo.toml
        id: get-version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  # Run tests before building
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run tests
        run: cargo test

  # Build matrix for all platforms
  build:
    needs: [extract-version, test]
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows builds (native)
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            use_cross: false
          - target: i686-pc-windows-msvc
            os: windows-latest
            use_cross: false
          # Windows ARM64 (native with target)
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            use_cross: false
          
          # macOS builds (native)
          - target: x86_64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            use_cross: false
          
          # Linux builds
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: false
          - target: i686-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cargo-bundle
        if: ${{ !matrix.use_cross && (runner.os == 'Windows' || runner.os == 'macOS') }}
        run: cargo install cargo-bundle
      
      - name: Cache cross installation
        if: matrix.use_cross
        id: cache-cross
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cross
          key: ${{ runner.os }}-cross-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cross-
      
      - name: Install cross (if needed)
        if: matrix.use_cross && steps.cache-cross.outputs.cache-hit != 'true'
        run: cargo install cross --git https://github.com/cross-rs/cross
      
      - name: Build (native)
        if: ${{ !matrix.use_cross }}
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./build.bat
          elif [ "$RUNNER_OS" == "macOS" ]; then
            ./build.sh
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash
      
      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --target ${{ matrix.target }}
      
      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          $VERSION = "${{ needs.extract-version.outputs.version }}"
          $TARGET = "${{ matrix.target }}"
          $ARTIFACT_NAME = "ping-monitor-$VERSION-$TARGET"
          
          New-Item -ItemType Directory -Force -Path "artifacts"
          
          # Check if MSI bundle was created
          $MSI_PATH = "target\release\bundle\msi\PingMonitor_${VERSION}_x64_en-US.msi"
          if (Test-Path $MSI_PATH) {
            Write-Host "Found MSI bundle at $MSI_PATH"
            Copy-Item $MSI_PATH "artifacts\PingMonitor.msi"
            Compress-Archive -Path "artifacts\PingMonitor.msi" -DestinationPath "$ARTIFACT_NAME.zip"
          } else {
            Write-Host "MSI not found, using plain executable"
            $BINARY_PATH = "target\$TARGET\release\ping-monitor.exe"
            Copy-Item $BINARY_PATH "artifacts\ping-monitor.exe"
            Compress-Archive -Path "artifacts\ping-monitor.exe" -DestinationPath "$ARTIFACT_NAME.zip"
          }
          
          Add-Content -Path $env:GITHUB_ENV -Value "ARTIFACT_NAME=$ARTIFACT_NAME"
        shell: pwsh
      
      - name: Prepare artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          VERSION="${{ needs.extract-version.outputs.version }}"
          TARGET="${{ matrix.target }}"
          ARTIFACT_NAME="ping-monitor-${VERSION}-${TARGET}"
          
          mkdir -p artifacts
          
          # Check if macOS app bundle was created
          if [ "$RUNNER_OS" == "macOS" ]; then
            APP_BUNDLE="target/release/bundle/osx/PingMonitor.app"
            if [ -d "$APP_BUNDLE" ]; then
              echo "Found macOS app bundle at $APP_BUNDLE"
              # Create a zip of the .app bundle
              (cd target/release/bundle/osx && zip -r "../../../../${ARTIFACT_NAME}.zip" PingMonitor.app)
              echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
              exit 0
            else
              echo "App bundle not found, using plain executable"
            fi
          fi
          
          # Fallback to plain binary
          BINARY_PATH="target/${TARGET}/release/ping-monitor"
          cp "$BINARY_PATH" "artifacts/ping-monitor"
          
          # Create ZIP archive
          cd artifacts
          zip "../${ARTIFACT_NAME}.zip" ping-monitor
          cd ..
          
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
        shell: bash
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.zip
          retention-days: 1

  # Create GitHub release
  release:
    needs: [extract-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts -name "*.zip" -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: Create release notes
        id: release-notes
        run: |
          VERSION="${{ needs.extract-version.outputs.version }}"
          NOTES="${{ github.event.inputs.release_notes }}"
          
          if [ -z "$NOTES" ]; then
            NOTES="Release version ${VERSION}"
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.extract-version.outputs.version }}
          name: Release v${{ needs.extract-version.outputs.version }}
          body: ${{ steps.release-notes.outputs.notes }}
          files: release-files/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
